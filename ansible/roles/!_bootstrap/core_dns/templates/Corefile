{% raw %}# .........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ansible_timestamp: {% endraw %}{{ ansible_managed | password_hash('sha512') }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# COREFILE: {% endraw %}{{ ansible_managed }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# version: {# blockchain dns system weights and counts latest changes in chanin which valid for us #}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PRIMARY DOMAIN IN DNS ENTRYPOINT
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}

{% if hostvars[inventory_hostname]['main_other_consul_domain'] is not defined %}
{{ public_consul_domain }} {% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['master-bind-master-backend'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:53 {% endraw %}{% endfor %}{% raw %}

    log
}{% endraw %}
{% endif %}
{% raw %}

# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PRIMARY CLOUD ZONE WITH SERIVCE DISCOVERY
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

cloud.{% endraw %}{{ public_consul_domain }} {% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['consul-masters'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ consul_dns_service_listen_port }} {% endfor %}{% raw %}
    log
}
{% endraw %}

{% if consul_internal_servers_sub_domain_zone is defined %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CONSUL SUB-ZONE FOR CLOUD LAYOUT BETWEEN DC WITH SERIVCE DISCOVERY: SOURCE DC PREPARE PLACEMENTS
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{{ consul_internal_servers_sub_domain_zone }} {% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['consul-masters'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ consul_dns_service_listen_port }} {% endfor %}{% raw %}
    log
}
{% endraw %}
{% endif %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# K8 DNS BACKEND FOR FORWARD/RECOURSE FROM IT
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

{% if INSIDE_K8_LOAD_BALANCER_DNS is defined %}{% if 'kubernetes-master' in group_names %}
{{ k8_cloud_domain_name }} {% raw %}{
    acl {
            allow net 0.0.0.0/0
        }
    forward . {% endraw %}{% for host in groups['kubernetes-master'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ k8s_cluster_dns_port_outside }} {% endfor %}{% raw %}
    log
}
{% endraw %}
{% endif %}{% endif %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -- PRIMARY DOMAIN SECTION END --
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# WORKS WITH ATTACHED SUB/DOMAINS
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{% if bind_cloud_settings.other_environments_subdomains is defined %}{% for item, children in bind_cloud_settings.other_environments_subdomains.items() %}{% set self_checking_domain_for_prevent_duplicate = item + '.' + production_public_domain %}{% set self_checking_domain_for_prevent_duplicate_matcher_primary = item + '.' + production_public_domain %}
{% raw %}
# .........................................................................................................................................................................................................................................................................................................
# # -------------------------------------------------------------------------------------------------
# # EXTENDED SUB/DOMAIN: {% endraw %}{{ item }}{% raw %}
# # -------------------------------------------------------------------------------------------------
# .........................................................................................................................................................................................................................................................................................................
{% endraw %}
{% if children.dc_dns_domain_genesis_kind is defined %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# GENESIS IS DEFINED, - {% endraw %}{{ children.dc_dns_domain_genesis_kind }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}{% if INSIDE_K8_LOAD_BALANCER_DNS is defined %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CHILD CLOUD SERVICE DISCOVERY IN OTHER DATACENTER K8 DOMAIN: {% endraw %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{% if main_other_consul_domain is defined %}
{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ children.dc_dns_domain_genesis_kind }} {% else %}{% if production_public_domain != public_consul_domain %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ children.dc_dns_domain_genesis_kind }} {% else %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ children.dc_dns_domain_genesis_kind }} {% endif %}{% endif %}{% raw %}{
    acl {
            allow net 0.0.0.0/0
        }{% endraw %}
    {% if children.rd_location is defined %}{% raw %}
    forward . {% endraw %}{% for c in children.dns_ip_list %}{{ c }}{% raw %}:53 {% endraw %}{% endfor %}
    {% else %}{% raw %}
    forward . {% endraw %}{% for host in groups['kubernetes-master'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ k8s_cluster_dns_port_outside }} {% endfor %}{% endif %}{% raw %}
    log

}
{% endraw %}
{% endif %}
# .........................................................................................................................................................................................................................................................................................................
{% if consul_service_discovery_state is true %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PUBLIC ZONE (DMZ) SERVICE DISCOVERY DOMAIN IF ENABLED PUBLISH: "{% endraw %}{{ consul_service_discovery_state }}{% raw %}"
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}{% if consul_cloud_domain_name is defined %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CHILD CLOUD SERVICE DISCOVERY IN OTHER DATACENTER CONSUL DOMAIN: {% endraw %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }}
{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{% if main_other_consul_domain is defined %}
{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ main_other_consul_domain }} {% else %}{% if production_public_domain != public_consul_domain %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ production_public_domain }} {% else %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }} {% endif %}{% endif %}{% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['consul-masters'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ consul_dns_service_listen_port }} {% endfor %}{% raw %}
    log
}
{% endraw %}
{% endif %}
{% endif %}

{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PRIMARY RECORD FOR SAME LEVEL DOMAIN
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}

{{ item }}{% raw %}.{% endraw %}{{ children.dc_dns_domain_genesis_kind }} {% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['master-bind-master-backend'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:53 {% endraw %}{% endfor %}{% raw %}

    log
}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# .........................................................................................................................................................................................................................................................................................................
{% endraw %}
{% else %}{% raw %}

# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{% if self_checking_domain_for_prevent_duplicate == primary_parent_shared_inventory_domain %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PRIMARY IN DATACENTER DOMAIN, NO ADD: {% endraw %}{{ self_checking_domain_for_prevent_duplicate }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}
{% else %}

{% if INSIDE_K8_LOAD_BALANCER_DNS is defined %}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CHILD CLOUD SERVICE DISCOVERY IN OTHER DATACENTER K8 DOMAIN: {% endraw %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}

{% if main_other_consul_domain is defined %}{% if 'kubernetes-master' in group_names %}
{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ main_other_consul_domain }} {% else %}{% if production_public_domain != public_consul_domain %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ production_public_domain }} {% else %}{{ k8_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }} {% endif %}{% endif %}{% raw %}{
    acl {
            allow net 0.0.0.0/0
        }
    forward . {% endraw %}{% for host in groups['kubernetes-master'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ k8s_cluster_dns_port_outside }} {% endfor %}{% raw %}
    log
}
{% endraw %}
{% endif %}{% endif %}

{% if consul_service_discovery_state is true %}
{% raw %}

# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PUBLIC ZONE (DMZ) SERVICE DISCOVERY DOMAIN IF ENABLED PUBLISH: "{% endraw %}{{ consul_service_discovery_state }}{% raw %}"
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}

{% if consul_cloud_domain_name is defined %}{% raw %}

# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CHILD CLOUD SERVICE DISCOVERY IN OTHER DATACENTER CONSUL DOMAIN: {% endraw %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

{% if main_other_consul_domain is defined %}
{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ main_other_consul_domain }} {% else %}{% if production_public_domain != public_consul_domain %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ production_public_domain }} {% else %}{{ consul_cloud_domain_name_public_prefix }}{% raw %}.{% endraw %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }} {% endif %}{% endif %}{% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['consul-masters'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:{% endraw %}{{ consul_dns_service_listen_port }} {% endfor %}{% raw %}
    log
}
{% endraw %}

{% endif %}
{% endif %}

{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# CHILD IN DATACENTER DOMAIN: {% endraw %}{{ self_checking_domain_for_prevent_duplicate }}{% raw %}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{% endraw %}

{% if main_other_consul_domain is defined %}

{{ item }}{% raw %}.{% endraw %}{{ main_other_consul_domain }} {% else %}{% if production_public_domain != public_consul_domain %}{{ item }}{% raw %}.{% endraw %}{{ production_public_domain }} {% else %}{{ item }}{% raw %}.{% endraw %}{{ public_consul_domain }} {% endif %}{% endif %}{% raw %}{
    acl {
        allow net 0.0.0.0/0
    }
    forward . {% endraw %}{% for host in groups['master-bind-master-backend'] %}{% if hostvars[host]['second_ip'] is defined %}{{ hostvars[host]['second_ip'] }}{% else %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}{% endif %}{% raw %}:53 {% endraw %}{% endfor %}{% raw %}
    log
}
{% endraw %}{% endif %}{% endif %}{% endfor %}{% endif %}

{% raw %}

# .........................................................................................................................................................................................................................................................................................................
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DNS FIREWALL: TO/FROM INTERNET FILTERING THE REQUESTS ONLY ALLOW THE LOCAL KNOWN NETWORKS AND SUBNETS
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

.:53 {
    acl {

        allow net {% endraw %}{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}{% raw %}/32 {% endraw %}{% if docker_networks.stdout != "" %}{% for item in docker_networks_subnets.results %}{{ item.stdout }} {% endfor %}{% endif %}
{% raw %}
        block
    }
    forward . 8.8.8.8
}
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# COREFILE END
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# .........................................................................................................................................................................................................................................................................................................
{% endraw %}