var AjaxGet=!1,GetTimeout=!1,MsgBox=!1,OnlineUsers=!1,OnlineCount=!1,LeftMenu_Messages=!1,OldOnlineArray=[],OriginalTitle="",TabActive=!0,GetError_FatalOccured=!1,NewMsgCount=0,LastSeenID_Used=!1,ReconnectCounter=0,MaxReconnectCounts=3,TitleFlashState=1,UserMentioned=!1,Messages={users:{},msgCount:0,firstID:0,lastID:0,lastGet:0},LastActivity_Time=0,LastActivity_Type=0,GetTimeout_MinVal=2500,GetTimeout_InitVal=5e3,GetTimeout_MaxVal=3e4,GetTimeout_IdleStart=6e4,GetTimeout_Current=GetTimeout_InitVal,GetTimeout_AddToIdle_Val=1e3,GetTimeout_AddToActive_Val=500,AjaxSettings={timeout:4e3},local_LastSeenID,TPL_NicknameReplace='<b class="skyblue">$1</b>',ReconnectInterval=!1,ErrorFadeOutTimeout=!1,SettingsInterval=!1,TitleFlashInterval=!1,ShoutBoxTable,SendButton,ErrorBox,ActivityBox,SettingsBox,YourNickname_RegExp,YourNicknameReplace_RegExp;function preg_quote(str,delimiter){return(str+"").replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\"+(delimiter||"")+"-]","g"),"\\$&")}function padTime(str){return 1==(str=""+str).length?"0"+str:0==str.length?"00":str}function createMessage(MessageData,curLastSeenID){var MsgOpt=[],AddLastMarker="",MsgDate=new Date(1e3*(MessageData.d+ServerStamp));return UserAuth>=90?(MsgOpt.push('<a class="delMsg" href="#"></a>'),MsgOpt.push('<a class="edit" href="chat_edit.php?mode='+MessageData.id+'"></a>')):MsgOpt.push('<a class="reportMsg" href="#" title="'+JSLang.ToolTip_ReportMsg+'"></a>'),void 0!==curLastSeenID&&!1===LastSeenID_Used&&MessageData.id==curLastSeenID&&(AddLastMarker=" lastSeen",LastSeenID_Used=!0),MsgOpt=MsgOpt.length>0?'<th valign="top">'+MsgOpt.join("&nbsp;")+"</th>":"",MsgDate=padTime(MsgDate.getHours())+":"+padTime(MsgDate.getMinutes())+", "+padTime(MsgDate.getDate())+"."+padTime(MsgDate.getMonth()+1)+"."+MsgDate.getFullYear(),'<tr id="sbmsg_'+MessageData.id+'" class="doFadeIn '+AddLastMarker+'"><th class="usr aright" valign="top" nowrap><a href="#" class="usrRef usrColor_'+Messages.users[MessageData.u].c+'" title="'+JSLang.usrRef+'">'+Messages.users[MessageData.u].n+'</a> <a href="profile.php?uid='+MessageData.u+'" class="usrColor_'+Messages.users[MessageData.u].c+'" target="_blank" title="'+JSLang.profile+'">#</a></th><th class="msg aleft">'+MessageData.t+'</th><th class="dt aright" valign="top" nowrap>('+MsgDate+")</th>"+MsgOpt+"</tr>"}function AddReference(Text){MsgBox.val(MsgBox.val()+Text+": ").focus()}function showMessage(){var ReqParam=null,ReCalc_FirstID=!1,ReCalc_LastID=!1,UpdateLastGetTime=!1;ReqParam=!1===Messages.init?{init:!0,rid:RoomID}:{rid:RoomID,fID:Messages.firstID,lID:Messages.lastID,lGet:Messages.lastGet,lCnt:Messages.msgCount},ActivityBox.show(0),AjaxGet=$.get("ajax/chat.msg.php",ReqParam).complete(function(reqResponse,reqStatus){if(ActivityBox.hide(0),"success"==reqStatus){var InAppError=!1;(ReconnectCounter>0||!0===GetError_FatalOccured)&&(GetError_FatalOccured=!1,ReconnectCounter=0,clearInterval(ReconnectInterval),UnThrowError(!0,!0));var Response={};if(""!=reqResponse.responseText&&(Response=$.parseJSON(reqResponse.responseText)),null!=Response.Err&&(InAppError=!0,ThrowError(JSLang_Errors["getErr_"+Response.Err],!0,!0,!0)),null!=Response.onl){var NewOnlineUsers=[],SplitText="",ThisOnlineArray=[];for(var i in Response.onl)SplitText=Response.onl[i].split("|"),NewOnlineUsers.push('<a href="#" class="usrRef usrColor_'+SplitText[2]+" "+(null!=SplitText[3]&&1==SplitText[3]?"usrInv":"")+'" title="'+JSLang.usrRef+'">'+SplitText[1]+'</a> <a href="profile.php?uid='+SplitText[0]+'" class="usrColor_'+SplitText[2]+'" target="_blank" title="'+JSLang.profile+'">#</a>'),ThisOnlineArray.push(SplitText[0]);if(OnlineUsers.html(", "+NewOnlineUsers.join(", ")),!1!==Messages.init){var FoundNewUser=!1;for(var Index in ThisOnlineArray)if(-1===$.inArray(ThisOnlineArray[Index],OldOnlineArray)){FoundNewUser=!0;break}!0===FoundNewUser&&(LastActivity_Time=(new Date).getTime(),LastActivity_Type=2)}OldOnlineArray=ThisOnlineArray}else OnlineUsers.html(""),OldOnlineArray=[];if(null==Response.onlCnt&&(Response.onlCnt=0),OnlineCount.html(parseInt(Response.onlCnt,10)+1),!0!==InAppError)if("delall"==Response.cmd)Messages={users:{},msgCount:0,firstID:0,lastID:0,lastGet:0},ShoutBoxTable.html("");else{if(null!=Response.usr)for(var UsrIdx in UpdateLastGetTime=!0,Response.usr)Messages.users[UsrIdx]=Response.usr[UsrIdx];if(null!=Response.edit)for(var EditMsgIdx in UpdateLastGetTime=!0,Response.edit)ShoutBoxTable.find("#sbmsg_"+EditMsgIdx+" > .msg").html(Response.edit[EditMsgIdx].t);if(null!=Response.del){UpdateLastGetTime=!0;var DelElement=!1;for(var DelMsgIdx in Response.del)(DelElement=ShoutBoxTable.find("#sbmsg_"+Response.del[DelMsgIdx])).length>0&&(Messages.msgCount-=1,DelElement.remove(),Response.del[DelMsgIdx]==Messages.lastID?ReCalc_LastID=!0:Response.del[DelMsgIdx]==Messages.firstID&&(ReCalc_FirstID=!0))}if(null!=Response.newm){LastActivity_Time=(new Date).getTime(),UpdateLastGetTime=!0;var NewMsgIdx=0,msgID=0;if(0==Messages.msgCount){var CombineMessages="";for(NewMsgIdx in Response.newm)msgID=Response.newm[NewMsgIdx].id,(Messages.firstID>msgID||0==Messages.firstID)&&(Messages.firstID=msgID),Messages.lastID<msgID&&(Messages.lastID=msgID),CombineMessages+=createMessage(Response.newm[NewMsgIdx],local_LastSeenID),Messages.msgCount+=1;ShoutBoxTable.fadeTo(0,.001),ShoutBoxTable.append(CombineMessages),$(".doFadeIn").removeClass("doFadeIn"),ShoutBoxTable.fadeTo(350,1)}else{LastActivity_Type=1;var ToAppend="",ToPrepend="";for(NewMsgIdx in Response.newm)msgID=Response.newm[NewMsgIdx].id,Messages.firstID>msgID?(Messages.firstID=msgID,ToAppend+=createMessage(Response.newm[NewMsgIdx])):(Messages.lastID<msgID&&(Messages.lastID=msgID),-1!==Response.newm[NewMsgIdx].t.search(YourNickname_RegExp)&&(Response.newm[NewMsgIdx].t=Response.newm[NewMsgIdx].t.replace(YourNicknameReplace_RegExp,TPL_NicknameReplace),UserMentioned=!0),!1===TabActive?NewMsgCount+=1:UserMentioned=!1,ToPrepend+=createMessage(Response.newm[NewMsgIdx])),Messages.msgCount+=1;if(!1===TabActive){var NewTitle=OriginalTitle+" ("+NewMsgCount+")";document.title=NewTitle,!0===UserMentioned&&(!1!==TitleFlashInterval&&clearInterval(TitleFlashInterval),TitleFlashState=1,TitleFlashInterval=setInterval(function(){1===TitleFlashState?(document.title=JSLang.mentioned,TitleFlashState=2):(document.title=NewTitle,TitleFlashState=1)},1e3))}""!=ToAppend&&(ShoutBoxTable.append(ToAppend),ToAppend=""),""!=ToPrepend&&(ShoutBoxTable.prepend(ToPrepend),ToPrepend=""),$(".doFadeIn").fadeTo(350,1).removeClass("doFadeIn")}}!0===UpdateLastGetTime&&(Messages.lastGet=parseInt((new Date).getTime()/1e3,10)-ServerStamp),0==Messages.msgCount?(Messages.firstID=0,Messages.lastID=0):1==Messages.msgCount?(!0===ReCalc_LastID&&(Messages.lastID=parseInt(ShoutBoxTable.find("tr:first").attr("id").replace("sbmsg_",""),10)),Messages.firstID=Messages.lastID):(!0===ReCalc_LastID&&(Messages.lastID=parseInt(ShoutBoxTable.find("tr:first").attr("id").replace("sbmsg_",""),10)),!0===ReCalc_FirstID&&(Messages.firstID=parseInt(ShoutBoxTable.find("tr:last").attr("id").replace("sbmsg_",""),10)))}if(null!=Response.lmMC){var LeftMenu_MessagesCount=LeftMenu_Messages.children("#lm_msgc");LeftMenu_MessagesCount.length>0?LeftMenu_MessagesCount.html("("+Response.lmMC+")"):LeftMenu_Messages.addClass("orange").append('<b id="lm_msgc">('+Response.lmMC+")</b>")}else LeftMenu_Messages.children("#lm_msgc").remove().end().removeClass("orange");LastActivity_Type>0?(GetTimeout_Current=1==LastActivity_Type?GetTimeout_MinVal:GetTimeout_InitVal,LastActivity_Type=0):(new Date).getTime()-LastActivity_Time>=GetTimeout_IdleStart?GetTimeout_Current<GetTimeout_MaxVal&&(GetTimeout_Current+=GetTimeout_AddToIdle_Val):GetTimeout_Current<GetTimeout_InitVal&&(GetTimeout_Current+=GetTimeout_AddToActive_Val),!0!==InAppError&&(GetTimeout=setTimeout(showMessage,GetTimeout_Current))}else"abort"!=reqStatus&&"notmodified"!=reqStatus&&(0==ReconnectCounter&&(clearTimeout(ErrorFadeOutTimeout),ThrowError("",!0,!0,!0)),clearInterval(ReconnectInterval),ReconnectCounter<MaxReconnectCounts?(GetError_FatalOccured=!1,ReconnectCounter+=1,ErrorBox.html(ErrorMsg.getError.replace("{x}",MaxReconnectCounts-ReconnectCounter+1)),ReconnectInterval=setTimeout(showMessage,5e3)):(GetError_FatalOccured=!0,ErrorBox.html(ErrorMsg.getErrorFatal)))})}function ThrowError(ThisErrorMsg,FadeChat,LockControl,NoUnThrow){void 0===ThisErrorMsg&&(ThisErrorMsg="&nbsp;"),void 0===FadeChat&&(FadeChat=!1),void 0===LockControl&&(LockControl=!1),void 0===NoUnThrow&&(NoUnThrow=!1),!0===FadeChat&&ShoutBoxTable.fadeTo(400,.5),!0===LockControl&&(SendButton.attr("disabled",!0),MsgBox.attr("disabled",!0)),ErrorBox.html(ThisErrorMsg).fadeIn(400,function(){!1===NoUnThrow&&(ErrorFadeOutTimeout=setTimeout(function(){UnThrowError(FadeChat,LockControl)},1500))})}function UnThrowError(UnFadeChat,UnLockControl){ErrorBox.fadeOut(400),!0===UnFadeChat&&ShoutBoxTable.fadeTo(400,1),!0===UnLockControl&&(SendButton.removeAttr("disabled"),MsgBox.removeAttr("disabled"))}function AjaxAbort(){void 0!==AjaxGet.readyState&&4!=AjaxGet.readyState&&AjaxGet.abort()}$(document).ready(function(){local_LastSeenID=LastSeenID,$.ajaxSetup(AjaxSettings),OriginalTitle=document.title;var YourNicknameEscaped=preg_quote(YourNickname);YourNickname_RegExp=new RegExp(YourNicknameEscaped,"gi"),YourNicknameReplace_RegExp=new RegExp("("+YourNicknameEscaped+")","gi"),MsgBox=$("#msgText"),ShoutBoxTable=$("#sbTable"),SendButton=$("#msgSend"),OnlineUsers=$("#onlineUsers"),OnlineCount=$("#onlineCount"),ErrorBox=$("#errorBox"),ActivityBox=$("#activityBox"),SettingsBox=$("#set_Loading"),LeftMenu_Messages=$("#lm_msg"),showMessage(),MsgBox.keypress(function(event){13!=event.keyCode||event.shiftKey||SendButton.click()}),ShoutBoxTable.on("click",".delMsg",function(){clearTimeout(GetTimeout);var ThisID=$(this).parent().parent().attr("id").replace("sbmsg_","");return ActivityBox.show(0),AjaxAbort(),$.get("ajax/chat.del.php",{id:ThisID}).success(function(data){var FoundError,NoUnThrow;(ActivityBox.hide(0),1!=data)&&(5!=data?(FoundError=ErrorMsg["jQueryAjax_delErr_"+data].replace("{$id}",ThisID),NoUnThrow=!1):(FoundError=ErrorMsg.jQueryAjax_notLogged,NoUnThrow=!0),ThrowError(FoundError,!1,!1,NoUnThrow));5!=data&&showMessage()}).error(function(){ActivityBox.hide(0),showMessage()}),!1}).on("click",".reportMsg",function(){var ThisID=$(this).parent().parent().attr("id").replace("sbmsg_",""),ThisUID=$(this).parent().parent().find("th.usr > a:not(.usrRef)").attr("href").replace("profile.php?uid=","");return window.location.href="report.php?type=9&uid="+ThisUID+"&eid="+ThisID,!1}),$("#shoutbox").on("click",".usrRef",function(event){event.preventDefault(),AddReference($(this).html())}),ErrorBox.on("click","#chatReload",function(){return!0===GetError_FatalOccured&&(ReconnectCounter=0,showMessage(),!1)}),SendButton.click(function(){""!=MsgBox.val()&&(clearTimeout(GetTimeout),MsgBox.attr("disabled",!0),SendButton.attr("disabled",!0),ActivityBox.show(0),AjaxAbort(),$.post("ajax/chat.add.php",{rid:RoomID,msg:MsgBox.val()}).success(function(data){var FoundError,NoUnThrow;(ActivityBox.hide(0),1==data)?(MsgBox.val("").removeAttr("disabled"),SendButton.removeAttr("disabled"),showMessage()):(4!=data?(FoundError=ErrorMsg["jQueryAjax_postErr_"+data],NoUnThrow=!1):(FoundError=ErrorMsg.jQueryAjax_notLogged,NoUnThrow=!0),ThrowError(FoundError,!0,!0,NoUnThrow),GetTimeout=setTimeout(showMessage,2500))}).error(function(){ActivityBox.hide(0),ThrowError(ErrorMsg.jQueryAjax_postError,!0,!0),GetTimeout=setTimeout(showMessage,2500)}))}),$(".setChg").change(function(){!1!==SettingsInterval&&clearTimeout(SettingsInterval),SettingsBox.fadeIn(0).attr("src","images/ajax-loader.gif");var ThisPost={},OnSuccess=function(){},RevertChange=!1,ThisElement=$(this);"checkbox"==$(this).attr("type")?(ThisPost[$(this).attr("name")]=$(this).is(":checked"),RevertChange=function(){ThisElement.prop("checked",!ThisElement.is(":checked"))},null!=ThisPost.setChg_1&&(!0===ThisPost.setChg_1?OnSuccess=function(){$("#onlineBox_you").addClass("usrInv")}:!1===ThisPost.setChg_1&&(OnSuccess=function(){$("#onlineBox_you").removeClass("usrInv")}))):(ThisPost[$(this).attr("name")]=$(this).val(),RevertChange=function(){ThisElement.val("")}),$.post("ajax/chat.settings.php",ThisPost).success(function(data){1==data?(SettingsBox.attr("src","images/tick.green.png"),OnSuccess()):(SettingsBox.attr("src","images/tick.red.png"),RevertChange()),SettingsInterval=setTimeout(function(){SettingsBox.fadeOut(500)},1e3)}).error(function(){SettingsBox.attr("src","images/delete.png"),SettingsInterval=setTimeout(function(){SettingsBox.fadeOut(500)},1e3)})}),$(window).blur(function(){TabActive=!1,local_LastSeenID<Messages.lastID&&($("#sbmsg_"+local_LastSeenID).removeClass("lastSeen"),$("#sbmsg_"+Messages.lastID).addClass("lastSeen"),local_LastSeenID=Messages.lastID)}).focus(function(){!1!==TitleFlashInterval&&clearInterval(TitleFlashInterval),UserMentioned=!1,TabActive=!0,NewMsgCount=0,document.title=OriginalTitle})});